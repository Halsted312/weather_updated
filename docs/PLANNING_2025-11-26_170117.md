# Kalshi Weather Trading Pipeline - Comprehensive Roadmap

**Created**: 2025-11-26 17:01:17
**Critical Reference**: `/home/halsted/weather_updated/docs/3_how_to_pull_all_high_temps.md`
**Fix Reference**: `/home/halsted/weather_updated/docs/5_fix_philly_date_alignments.md`

---

## Executive Summary

Building a comprehensive data pipeline for Kalshi weather temperature markets across 6 cities. The system ingests market data, candlestick prices, weather observations, and settlement temperatures from multiple sources.

### Current Database State (as of 2025-11-26)

| Data Source | Records | Coverage |
|-------------|---------|----------|
| Kalshi Markets | ~22,917 | 5 cities (Philadelphia missing due to ticker bug) |
| Candles (1-min) | ~3.6M | 5 cities |
| Weather Observations | ~2.05M | 5 cities (Philadelphia missing) |
| Settlement (TMAX) | 8,550 | 6 cities (2022-01-01 to 2025-11-25) |

### D_global (Continuous Backtest Window)

| Scenario | Window | Days |
|----------|--------|------|
| 5 cities (excl. Philadelphia) | 2025-01-05 to 2025-11-25 | 325 |
| 3 cities (Austin, Chicago, Miami) | 2023-05-12 to 2025-11-25 | 929 |
| Chicago only | 2022-01-01 to 2025-11-25 | 1,425 |

---

## COMPLETED WORK

### Phase 1: Core Infrastructure

| Task | Status | Files |
|------|--------|-------|
| Global Kalshi rate limiter | DONE | `src/utils/rate_limiter.py` |
| Retry decorators (tenacity) | DONE | `src/utils/retry.py` |
| Checkpoint system | DONE | `src/db/checkpoint.py`, `migrations/versions/002_add_checkpoint.py` |
| Kalshi client with rate limiting | DONE | `src/kalshi/client.py` |

### Phase 2: Data Ingestion Pipelines

| Pipeline | Status | Records | Script |
|----------|--------|---------|--------|
| Markets backfill | DONE | 22,917 | `scripts/backfill_kalshi_markets.py` |
| Candles backfill | DONE | ~3.6M | `scripts/backfill_kalshi_candles.py` |
| VC weather backfill | DONE | ~2.05M | `scripts/ingest_vc_minutes.py` |

### Phase 3: Multi-Source Settlement Pipeline

| Task | Status | Files |
|------|--------|-------|
| IEM CLI JSON client | DONE | `src/weather/iem_cli.py` |
| NCEI Access v1 client (no token) | DONE | `src/weather/noaa_ncei.py` (NCEIAccessClient) |
| Settlement schema expansion | DONE | `migrations/versions/003_expand_settlement.py` |
| WxSettlement model update | DONE | `src/db/models.py` |
| Multi-source ingestion script | DONE | `scripts/ingest_settlement_multi.py` |
| Settlement backfill (6 cities) | DONE | 8,550 records |

**Settlement Data Quality**:
- 87.4% exact match between IEM and NCEI
- 93.4% within 1°F
- 3,940 records (46%) linked to Kalshi settlement buckets

---

## IN PROGRESS: Philadelphia & Float Bucket Fixes

Per `/home/halsted/weather_updated/docs/5_fix_philly_date_alignments.md`:

### Task 1: Fix Philadelphia Series Ticker

**Problem**: Philadelphia markets missing because series_ticker was `KXHIGHPHL` instead of `KXHIGHPHIL`.

**Status**: COMPLETED

**Changes Made**:
```python
# src/config/cities.py line 75
series_ticker="KXHIGHPHIL",  # Note: Kalshi uses "PHIL" not "PHL"
```

```python
# scripts/backfill_kalshi_markets.py legacy_map
"HIGHPHIL": "philadelphia",  # Added - Kalshi uses PHIL not PHL
```

### Task 2: Fix Float Bucket Parsing

**Problem**: Current code only parses integer buckets (B50), but Kalshi now uses half-degree floats (B55.5) with 2°F width.

**Status**: COMPLETED

**Changes Made** in `scripts/backfill_kalshi_markets.py`:
```python
# Before: int(re.search(r"B(\d+)", strike_part).group(1))
# After:
m = re.search(r"B(\d+(?:\.\d+)?)", strike_part)
if m:
    floor_val = float(m.group(1))
    # Detect bucket width: if floor has decimal (.5), it's new 2°F format
    if "." in m.group(1):
        bucket_width = 2.0  # New 2°F buckets (B55.5 -> 55.5-57.5)
    else:
        bucket_width = 4.0  # Legacy 5°F buckets (B50 -> 50-54)
    floor_strike = floor_val
    cap_strike = floor_val + bucket_width
```

### Task 3: Update Strike Columns to DECIMAL

**Problem**: `floor_strike` and `cap_strike` are SMALLINT, can't store 55.5.

**Status**: TODO

**Required Migration**:
```sql
-- migrations/versions/004_float_strikes.py
ALTER TABLE kalshi.markets
    ALTER COLUMN floor_strike TYPE DOUBLE PRECISION,
    ALTER COLUMN cap_strike TYPE DOUBLE PRECISION;

ALTER TABLE wx.settlement
    ALTER COLUMN settled_floor_strike TYPE DOUBLE PRECISION,
    ALTER COLUMN settled_cap_strike TYPE DOUBLE PRECISION;
```

**Model Update** in `src/db/models.py`:
```python
# Change from SmallInteger to Float
floor_strike: Mapped[Optional[float]] = mapped_column(Float, nullable=True)
cap_strike: Mapped[Optional[float]] = mapped_column(Float, nullable=True)
```

### Task 4: Normalize Candle bucket_start

**Problem**: API candles use `end_period_ts` but store it as `bucket_start`. Should subtract 60s for true bar start.

**Status**: TODO

**Location**: `scripts/backfill_kalshi_candles.py`

**Fix**:
```python
# When processing API event candles:
bucket_start = datetime.fromtimestamp(candle.end_period_ts - 60, tz=timezone.utc)
```

### Task 5: Re-run Philadelphia Backfills

**Status**: TODO

**Commands**:
```bash
# 1. Re-backfill Philadelphia markets
python scripts/backfill_kalshi_markets.py --city philadelphia --all-history

# 2. Re-backfill Philadelphia candles
python scripts/backfill_kalshi_candles.py --city philadelphia --all-history --source api_event

# 3. Backfill Philadelphia VC weather
python scripts/ingest_vc_minutes.py --city philadelphia --all-history

# 4. Verify
python scripts/check_data_state.py
```

---

## REMAINING WORK

### Immediate Tasks (Priority Order)

1. **Create migration 004_float_strikes.py** - Change strike columns to DOUBLE PRECISION
2. **Update KalshiMarket model** - Change floor_strike/cap_strike to Float
3. **Fix candle bucket_start alignment** - Subtract 60s from end_period_ts
4. **Re-run Philadelphia backfills** - Markets, candles, VC weather
5. **Re-run ALL markets backfill** - To capture float strikes correctly
6. **Verify with check_data_state.py**

### Data Verification Queries

```sql
-- Check Philadelphia markets after re-backfill
SELECT COUNT(*), MIN(event_date), MAX(event_date)
FROM kalshi.markets
WHERE city = 'philadelphia';

-- Check float strikes are stored correctly
SELECT ticker, floor_strike, cap_strike
FROM kalshi.markets
WHERE ticker LIKE '%B55.5%' OR ticker LIKE '%B57.5%'
LIMIT 10;

-- Check candle alignment
SELECT ticker, bucket_start, source
FROM kalshi.candles_1m
WHERE source = 'api_event'
ORDER BY bucket_start DESC
LIMIT 10;
```

---

## ARCHITECTURE OVERVIEW

### Database Schema

```
kalshi schema:
├── markets (ticker PK, city, event_date, strike_type, floor_strike, cap_strike, result, raw_json)
└── candles_1m (ticker, bucket_start, source PK, OHLC, volume, open_interest)

wx schema:
├── settlement (city, date_local PK, tmax_cli_f, tmax_iem_f, tmax_ncei_f, tmax_final, settled_ticker, ...)
└── minute_obs (loc_id, ts_utc PK, temp_f, humidity, wind, raw_json)

meta schema:
└── ingestion_checkpoint (pipeline_name, city, status, last_processed_date, total_processed)
```

### City Configuration

**File**: `src/config/cities.py`

| City | ICAO | Series Ticker | Timezone | GHCND Station |
|------|------|---------------|----------|---------------|
| Chicago | KMDW | KXHIGHCHI | America/Chicago | USW00014819 |
| Austin | KAUS | KXHIGHAUS | America/Chicago | USW00013958 |
| Denver | KDEN | KXHIGHDEN | America/Denver | USW00003017 |
| Los Angeles | KLAX | KXHIGHLAX | America/Los_Angeles | USW00023174 |
| Miami | KMIA | KXHIGHMIA | America/New_York | USW00012839 |
| Philadelphia | KPHL | **KXHIGHPHIL** | America/New_York | USW00013739 |

**Note**: Philadelphia uses `KXHIGHPHIL` (not KXHIGHPHL) - this was the root cause of missing Philadelphia data.

### Data Sources

| Source | API | Purpose | Rate Limit |
|--------|-----|---------|------------|
| Kalshi API | REST | Markets, candles | ~20 req/sec |
| Visual Crossing | Timeline API | 5-min weather obs | 1000 req/day |
| IEM CLI JSON | `mesonet.agron.iastate.edu/json/cli.py` | Historical TMAX | 1 req/sec |
| NCEI Access v1 | `ncei.noaa.gov/access/services/data/v1` | TMAX validation | 1 req/sec |

### Settlement TMAX Precedence

When multiple sources have different values:
```
IEM CLI > CF6 > NCEI > ADS
```

All values stored in separate columns for audit/comparison.

---

## SCRIPTS REFERENCE

### Backfill Scripts

| Script | Purpose | Key Options |
|--------|---------|-------------|
| `backfill_kalshi_markets.py` | Fetch all market metadata | `--city`, `--all-history`, `--resume` |
| `backfill_kalshi_candles.py` | Fetch 1-min candlesticks | `--city`, `--all-history`, `--source api_event|trades|both` |
| `ingest_vc_minutes.py` | Fetch 5-min weather obs | `--city`, `--all-history`, `--resume` |
| `ingest_settlement_multi.py` | Multi-source TMAX ingestion | `--city`, `--all-cities`, `--all-history`, `--resume` |

### Utility Scripts

| Script | Purpose |
|--------|---------|
| `check_data_state.py` | Show coverage summary per city/source |
| `migrate_candles_add_source.py` | One-time migration for candle sources |

---

## KEY LEARNINGS & GOTCHAS

1. **Philadelphia ticker**: Kalshi uses `KXHIGHPHIL` not `KXHIGHPHL` - always verify against live Kalshi URLs.

2. **Float buckets**: New markets use B55.5 format (2°F bins), legacy uses B50 (5°F bins). Parse with float regex.

3. **Candle timestamp**: API returns `end_period_ts`, subtract 60s to get true bar start.

4. **NYC excluded**: Central Park (KNYC) has 82% forward-fill in Visual Crossing - not usable.

5. **IEM vs NCEI**: IEM CLI JSON is the primary source (same as NWS daily climate reports). NCEI is validation/fallback.

6. **LA & Denver are new**: Los Angeles markets started ~2025-01-05, Denver ~2024-11-20. Limits D_global.

7. **Multiple YES markets**: Overlapping "above X°F" markets can both settle YES. Pick highest floor_strike for most specific bucket.

---

## NEXT SESSION CHECKLIST

When resuming work, execute in order:

```bash
# 1. Create float strike migration
# Edit: migrations/versions/004_float_strikes.py

# 2. Run migration
alembic upgrade head

# 3. Update models
# Edit: src/db/models.py (change SmallInteger to Float for strikes)

# 4. Fix candle bucket alignment
# Edit: scripts/backfill_kalshi_candles.py (subtract 60s from end_period_ts)

# 5. Re-run Philadelphia backfills
python scripts/backfill_kalshi_markets.py --city philadelphia --all-history
python scripts/backfill_kalshi_candles.py --city philadelphia --all-history --source api_event
python scripts/ingest_vc_minutes.py --city philadelphia --all-history

# 6. Re-run ALL markets to capture float strikes
python scripts/backfill_kalshi_markets.py --all-cities --all-history

# 7. Verify
python scripts/check_data_state.py

# 8. Recompute D_global
# Run the D_global computation query from earlier
```

---

## FILES MODIFIED IN THIS SESSION

| File | Change |
|------|--------|
| `src/config/cities.py:75` | Fixed Philadelphia series_ticker to KXHIGHPHIL |
| `scripts/backfill_kalshi_markets.py:93-128` | Updated to parse float buckets (B55.5) |
| `scripts/backfill_kalshi_markets.py:140` | Added HIGHPHIL to legacy_map |
| `src/weather/iem_cli.py` | Created - IEM CLI JSON client |
| `src/weather/noaa_ncei.py` | Added NCEIAccessClient (no token required) |
| `src/db/models.py` | Expanded WxSettlement with multi-source columns |
| `migrations/versions/003_expand_settlement.py` | Created - settlement schema expansion |
| `scripts/ingest_settlement_multi.py` | Created - multi-source settlement ingestion |

---

## CONTACT & RESOURCES

- **Kalshi API Docs**: https://trading-api.readme.io/
- **Visual Crossing API**: https://www.visualcrossing.com/resources/documentation/
- **IEM CLI JSON**: https://mesonet.agron.iastate.edu/json/cli.py
- **NCEI Access**: https://www.ncei.noaa.gov/access/services/data/v1
