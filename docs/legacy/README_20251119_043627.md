# Kalshi Weather Momentum

## Mission
Build a repeatable way to make money on Kalshi's "Highest Temperature" markets by fusing high-frequency order book signals with station-pinned weather intel. The system focuses on squeezing edge from short bursts of cross-bracket momentum while keeping probabilities coherent, fees low, and risk capped.

## Strategy Pillars
1. **Cross-bracket acceleration** – Track velocity/acceleration of every bracket, detect when one bin starts to lead its neighbors, and trade the migration of the entire probability mass. Adapted from the `Weather Bracket Agent` spec in `agent_design.md`.
2. **Logistic-normal PMF filter** – Maintain a coherent distribution over brackets by blending market mid-prices with Monte Carlo weather nowcasts (UKF/EKF or particle filter style).
3. **Microstructure pressure** – Feed OFI, queue imbalance, Hawkes intensities, and maker-fill odds into short-horizon classifiers that decide whether to lean maker-only or cross the spread.
4. **5-minute Visual Crossing data** – Lock to the settlement station via `stn:<ID>` + `aggregateMinutes=5` (see `how-to_visual_crossing.md` / `VC_IMPLEMENTATION_SUMMARY.md`) to keep running highs, hazards, and weather priors clean.
5. **Maker-first execution** – Price in exact Kalshi fees (`0.0175·p(1-p)` maker, `0.07·p(1-p)` taker), inventory controls, and paper/live switches before committing capital.

## System Architecture
```
┌─────────────────────────────────────────┐
│         DATA INGESTION LAYER            │
│  (Kalshi WebSocket + Visual Crossing)   │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│         FEATURE ENGINEERING             │
│  (Order Book + Weather + Cross-Bracket) │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│         PREDICTION MODELS               │
│  (Logistic-Normal + VARX + Hawkes)      │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│         SIGNAL GENERATION               │
│  (Acceleration Gates + Coherence)       │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│         EXECUTION ENGINE                │
│  (Maker-First + Risk + Backtests)       │
└─────────────────────────────────────────┘
```

### Data Ingestion & Storage
- **Kalshi WebSocket & REST** – Subscribe to all brackets per city (`orderbook_snapshot` → `orderbook_delta`) and persist YES/NO bid ladders. Reference stubs under `samples_py_files/kalshi/`.
- **Visual Crossing Timeline API** – Station-locked `stn:<STATION_ID>` pulls at 5-minute cadence. NYC is excluded per `how-to_weather_non_NYC.md` due to unacceptable forward-fill levels.
- **Database targets** – TimescaleDB / Postgres tables for order book snapshots, trades, VC minute data (with `stations` column), and derived features.

### Feature Engineering
- **Kinematics** – Mid, velocity, acceleration, neighbor spreads, PMF center of mass (`μ, μ̇, μ̈`).
- **Order-flow pressure** – OFI, queue imbalance, Hawkes intensity, maker fill odds.
- **Weather features** – Running high gap, hazard that a new high prints in the next Δ minutes, diurnal regime flags.

### Modeling & Calibration
- **Logistic-normal PMF tracker** – Keeps bracket probabilities normalized while fusing market + weather priors.
- **Short-horizon classifiers** – Ridge/GBDT/online GBM predicting Δp over 5–60 seconds; calibrated with Platt, isotonic, or beta scaling per `agent_design.md`.
- **Walk-forward training** – 42→7 day rolling windows (see guidance in `Instructions - phase 3.md`) with Optuna tuning and artifact export.

### Signals & Execution
- **Leader–follower** – Buy bracket *j* when acceleration, order-flow, and hazard align; scale aggression if Hawkes intensity spikes.
- **Migration** – Shift inventory up/down the distribution when PMF center accelerates.
- **Risk & fees** – Daily loss caps, per-bracket exposure, hazard throttles, cancel-on-disconnect, maker/taker EV comparison.
- **Backtests** – Replay L2 + VC temps with fee-aware fill models; shadow mode before live deployment.

## Reference Python Pack (`samples_py_files/`)
Use these files as templates when rebuilding production code:
- `kalshi/` – Minimal API client, schemas, and strike parser for parsing bracket metadata.
- `weather/` – VC + NOAA/NOAA-derived helpers (`visual_crossing.py`, `vc_daily_max.py`, `nws_cf6.py`, etc.) and shared time utilities.
- `ingest/` – Batch and streaming loaders (`backfill_visualcrossing.py`, `continuous_ingest.py`, `daily_update.py`, settlement reconciliation, etc.).
Each folder demonstrates the data model, validation hooks, and scheduling patterns needed for the real system.

## Setup & Usage (baseline)
1. **Environment configuration** – Copy `.env.example` to `.env` and set:
   ```
   CITY=chicago
   STATION_ID=KMDW
   VC_API_KEY=...
   KALSHI_API_KEY=...
   TRADE_MODE=paper      # switch to live after shadow testing
   DB_URL=postgres://user:pass@postgres:5432/kalshi
   ```
2. **Docker Compose stack** – Bring up Postgres/TimescaleDB, Redis, and the trading containers:
   ```bash
   docker compose up --build
   ```
   Services typically include `kalshi_ws`, `vc_ingest`, `signals`, `exec`, and optional `backtest` jobs (see original README stubs now stored in `README1.md`).
3. **Data/backtest workflow** – Use the Makefile targets from `README (2).md` (`make ingest-...`, `make load-to-db`, `make fetch-weather`, `make backtest-chicago`) to seed the database before training models.
4. **Testing & linting** – `make test`, `make lint`, and `make format` keep the codebase healthy during iteration.

## Roadmap & Readiness Criteria
1. **Foundation** – Stand up ingestion + database + Docker (Weeks 1–2).
2. **Models** – Train PMF filters, short-horizon classifiers, and hazard models (Weeks 3–4).
3. **Signals** – Wire acceleration logic, calibration, and coherence gates (Weeks 5–6).
4. **Paper trading** – Run fee-aware simulations & shadow orders (Weeks 7–8).
5. **Live trading** – Deploy gradually once the following are true:
   - 30+ days of clean data across target cities
   - Backtest Sharpe > 1.0 and paper-trading win rate > 55%
   - Max drawdown < 15% and daily loss caps enforced
   - 99%+ system uptime with automated monitoring & alerts

## Supporting Documents
- `README1.md` – Original detailed design spec with code snippets.
- `README3.md` – High-level business/architecture overview and risk considerations.
- `README (2).md` – Legacy Makefile-driven workflow for ingestion, training, and backtesting.
- `agent_design.md` – Deep dive into features, models, signals, execution, and calibration.
- `VC_IMPLEMENTATION_SUMMARY.md`, `how-to_visual_crossing.md`, `how-to_weather_non_NYC.md` – Weather ingestion requirements and validation results.
- `Instructions - phase 3.md` – Step-by-step build plan for the production system.

Use this README as the single entry point; dive into the supporting docs when you need implementation-level detail.
